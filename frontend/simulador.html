<!DOCTYPE html>
<html lang="pt-BR">
<head>
<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-VEKTLSP8Q9"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-VEKTLSP8Q9');
</script>    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador - Visto Americano</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        .fade-in {
            animation: fadeIn 0.4s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50" x-data="simuladorApp()" x-init="init()">
    
    <!-- Header -->
    <nav class="bg-white shadow-sm fixed w-full top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center cursor-pointer" onclick="location.href='index.html'">
                    <i class="fas fa-passport text-blue-600 text-3xl mr-3"></i>
                    <span class="text-xl font-bold text-gray-900">Visto Americano</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-600">
                        <i class="fas fa-clock mr-1"></i>
                        <span x-text="tempoDecorrido"></span>
                    </div>
                    <button onclick="if(confirm('Deseja sair? Seu progresso será perdido.')) location.href='index.html'" class="text-gray-600 hover:text-red-600 transition">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="pt-20 min-h-screen pb-8">
        
        <!-- Loading State -->
        <div x-show="loading" class="max-w-4xl mx-auto px-4 py-20 text-center">
            <div class="inline-block animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mb-4"></div>
            <p class="text-gray-600 text-lg">Carregando perguntas...</p>
        </div>

        <!-- Error State -->
        <div x-show="erro" class="max-w-4xl mx-auto px-4 py-20">
            <div class="bg-red-50 border border-red-200 rounded-lg p-8 text-center">
                <i class="fas fa-exclamation-circle text-red-600 text-5xl mb-4"></i>
                <h2 class="text-2xl font-bold text-red-900 mb-2">Erro ao Carregar</h2>
                <p class="text-red-700 mb-6" x-text="mensagemErro"></p>
                <button @click="init()" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition">
                    <i class="fas fa-redo mr-2"></i>
                    Tentar Novamente
                </button>
            </div>
        </div>

        <!-- Progress Bar -->
        <div x-show="!loading && !erro" class="max-w-4xl mx-auto px-4 mb-8">
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex justify-between items-center mb-3">
                    <div>
                        <span class="text-sm font-medium text-gray-600">Progresso</span>
                        <span class="ml-2 text-sm text-blue-600 font-bold" x-text="Math.round(progresso) + '%'"></span>
                    </div>
                    <div class="text-sm text-gray-600">
                        <span class="font-bold" x-text="indiceAtual + 1"></span> / 
                        <span x-text="totalPerguntas"></span> perguntas
                    </div>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                    <div class="progress-bar bg-blue-600 h-3 rounded-full" 
                         :style="'width: ' + progresso + '%'"></div>
                </div>
            </div>
        </div>

        <!-- Question Card -->
        <div x-show="!loading && !erro && !finalizando" class="max-w-4xl mx-auto px-4 fade-in">
            <div class="bg-white rounded-xl shadow-lg p-8">
                
                <!-- Category Badge -->
                <div class="mb-6">
                    <span class="bg-blue-100 text-blue-800 px-4 py-2 rounded-full text-sm font-semibold" 
                          x-text="perguntaAtual?.categoria?.toUpperCase() || 'CATEGORIA'"></span>
                    <span class="ml-3 text-gray-500 text-sm">
                        <i class="fas fa-lightbulb mr-1"></i>
                        <span x-text="perguntaAtual?.tipo_pergunta === 'ds160' ? 'DS-160' : 'Entrevista'"></span>
                    </span>
                </div>

                <!-- Question -->
                <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-6" 
                    x-text="perguntaAtual?.pergunta_texto"></h2>

                <!-- Dica -->
                <div x-show="perguntaAtual?.dica" class="bg-amber-50 border-l-4 border-amber-400 p-4 mb-6">
                    <div class="flex">
                        <i class="fas fa-lightbulb text-amber-500 mt-1 mr-3"></i>
                        <div>
                            <p class="text-sm font-medium text-amber-800">Dica:</p>
                            <p class="text-sm text-amber-700" x-text="perguntaAtual?.dica"></p>
                        </div>
                    </div>
                </div>

                <!-- Answer Input - Texto -->
                <div x-show="perguntaAtual?.tipo_resposta === 'texto' || !perguntaAtual?.tipo_resposta" class="mb-8">
                    <textarea 
                        x-model="respostaAtual"
                        rows="5"
                        class="w-full border-2 border-gray-300 rounded-lg p-4 focus:border-blue-600 focus:ring-2 focus:ring-blue-200 transition"
                        placeholder="Digite sua resposta aqui... Seja específico e honesto."
                    ></textarea>
                    <p class="text-sm text-gray-500 mt-2">
                        <span x-text="respostaAtual?.length || 0"></span> caracteres
                    </p>
                </div>

                <!-- Answer Input - Múltipla Escolha -->
                <div x-show="perguntaAtual?.tipo_resposta === 'multipla_escolha' && perguntaAtual?.opcoes?.length > 0" class="mb-8 space-y-3">
                    <template x-for="(opcao, index) in perguntaAtual?.opcoes || []" :key="index">
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition"
                               :class="respostaAtual === opcao ? 'border-blue-600 bg-blue-50' : ''">
                            <input 
                                type="radio" 
                                :value="opcao" 
                                x-model="respostaAtual"
                                class="w-5 h-5 text-blue-600 focus:ring-blue-500">
                            <span class="ml-3 text-gray-900 font-medium" x-text="opcao"></span>
                        </label>
                    </template>
                </div>

                <!-- Answer Input - Sim/Não -->
                <div x-show="perguntaAtual?.tipo_resposta === 'sim_nao' || (perguntaAtual?.opcoes?.length === 0 && perguntaAtual?.tipo_resposta === 'multipla_escolha')" class="mb-8 flex gap-4">
                    <label class="flex-1 flex items-center justify-center p-6 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-green-400 hover:bg-green-50 transition"
                           :class="respostaAtual === 'Sim' ? 'border-green-600 bg-green-50' : ''">
                        <input type="radio" value="Sim" x-model="respostaAtual" class="hidden">
                        <div class="text-center">
                            <i class="fas fa-check-circle text-4xl mb-2" :class="respostaAtual === 'Sim' ? 'text-green-600' : 'text-gray-400'"></i>
                            <p class="font-bold text-lg">Sim</p>
                        </div>
                    </label>
                    
                    <label class="flex-1 flex items-center justify-center p-6 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-red-400 hover:bg-red-50 transition"
                           :class="respostaAtual === 'Não' ? 'border-red-600 bg-red-50' : ''">
                        <input type="radio" value="Não" x-model="respostaAtual" class="hidden">
                        <div class="text-center">
                            <i class="fas fa-times-circle text-4xl mb-2" :class="respostaAtual === 'Não' ? 'text-red-600' : 'text-gray-400'"></i>
                            <p class="font-bold text-lg">Não</p>
                        </div>
                    </label>
                </div>

                <!-- Navigation Buttons -->
                <div class="flex justify-between items-center pt-6 border-t">
                    <button 
                        @click="voltarPergunta()"
                        x-show="indiceAtual > 0"
                        class="flex items-center text-gray-600 hover:text-gray-900 font-medium transition">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Anterior
                    </button>
                    <div x-show="indiceAtual === 0"></div>
                    
                    <button 
                        @click="proximaPergunta()"
                        :disabled="!respostaAtual && respostaAtual !== 0"
                        :class="(respostaAtual || respostaAtual === 0) ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-300 cursor-not-allowed'"
                        class="flex items-center text-white px-8 py-3 rounded-lg font-bold transition">
                        <span x-text="indiceAtual >= totalPerguntas - 1 ? 'Finalizar' : 'Próxima'"></span>
                        <i :class="indiceAtual >= totalPerguntas - 1 ? 'fa-check' : 'fa-arrow-right'" class="fas ml-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Finalizando -->
        <div x-show="finalizando" class="max-w-4xl mx-auto px-4 py-20 text-center">
            <div class="bg-white rounded-xl shadow-lg p-12">
                <div class="inline-block animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mb-6"></div>
                <h2 class="text-3xl font-bold text-gray-900 mb-4">Analisando suas respostas...</h2>
                <p class="text-gray-600 text-lg mb-2">Calculando pontuação</p>
                <p class="text-gray-600 text-lg mb-2">Avaliando vínculos com Brasil</p>
                <p class="text-gray-600 text-lg">Gerando recomendações personalizadas</p>
            </div>
        </div>

    </div>

    <script>
        function simuladorApp() {
            return {
                // Estado
                loading: true,
                erro: false,
                mensagemErro: '',
                finalizando: false,
                
                // Perguntas
                perguntas: [],
                indiceAtual: 0,
                respostas: {},
                respostaAtual: '',
                
                // Timer
                inicioTempo: null,
                tempoDecorrido: '0:00',
                timerInterval: null,
                
                // API Config
                apiUrl: 'https://web-production-e07b4.up.railway.app',
                
                // Computed
                get perguntaAtual() {
                    return this.perguntas[this.indiceAtual] || null;
                },
                
                get totalPerguntas() {
                    return this.perguntas.length;
                },
                
                get progresso() {
                    return this.totalPerguntas > 0 ? ((this.indiceAtual + 1) / this.totalPerguntas) * 100 : 0;
                },
                
                // Inicialização
                async init() {
                    this.loading = true;
                    this.erro = false;
                    this.inicioTempo = Date.now();
                    this.iniciarTimer();
                    
                    try {
                        // Pegar token do localStorage
                        const token = localStorage.getItem('token');
                        if (!token) {
                            throw new Error('Você precisa fazer login primeiro');
                        }
                        
                        const headers = {
                            'Authorization': `Bearer ${token}`
                        };
                        
                        // Verificar plano do usuário via API
                        const statusResponse = await fetch(`${this.apiUrl}/api/pagamentos/status`, { headers });
                        const statusData = await statusResponse.json();
                        const isPremium = statusData.plano === 'premium';
                        
                        console.log('Plano do usuário:', isPremium ? 'PREMIUM' : 'GRATUITO');
                        
                        // Carregar perguntas DS-160
                        const respostaDs160 = await fetch(`${this.apiUrl}/api/perguntas-ds160?gratuito=${!isPremium}`, { headers });
                        if (!respostaDs160.ok) throw new Error('Erro ao carregar perguntas DS-160');
                        const perguntasDs160 = await respostaDs160.json();
                        
                        // Carregar perguntas Entrevista
                        const respostaEntrevista = await fetch(`${this.apiUrl}/api/perguntas-entrevista?gratuito=${!isPremium}`, { headers });
                        if (!respostaEntrevista.ok) throw new Error('Erro ao carregar perguntas de entrevista');
                        const perguntasEntrevista = await respostaEntrevista.json();
                        
                        // Combinar e adicionar tipo
                        this.perguntas = [
                            ...perguntasDs160.map(p => ({...p, tipo_pergunta: 'ds160'})),
                            ...perguntasEntrevista.map(p => ({...p, tipo_pergunta: 'entrevista'}))
                        ];
                        
                        // Embaralhar (opcional)
                        // this.perguntas = this.perguntas.sort(() => Math.random() - 0.5);
                        
                        if (this.perguntas.length === 0) {
                            throw new Error('Nenhuma pergunta disponível');
                        }
                        
                        this.loading = false;
                        
                    } catch (error) {
                        console.error('Erro:', error);
                        this.erro = true;
                        this.mensagemErro = 'Não foi possível conectar à API. Certifique-se de que o servidor está rodando em ' + this.apiUrl;
                        this.loading = false;
                    }
                },
                
                // Timer
                iniciarTimer() {
                    this.timerInterval = setInterval(() => {
                        const decorrido = Math.floor((Date.now() - this.inicioTempo) / 1000);
                        const minutos = Math.floor(decorrido / 60);
                        const segundos = decorrido % 60;
                        this.tempoDecorrido = `${minutos}:${segundos.toString().padStart(2, '0')}`;
                    }, 1000);
                },
                
                // Navegação
                proximaPergunta() {
                    if (!this.respostaAtual && this.respostaAtual !== 0 && this.respostaAtual !== '') {
                        alert('Por favor, responda a pergunta antes de continuar.');
                        return;
                    }
                    
                    // Salvar resposta
                    this.respostas[this.perguntaAtual.id] = {
                        pergunta_id: this.perguntaAtual.id,
                        tipo_pergunta: this.perguntaAtual.tipo_pergunta,
                        resposta_usuario: this.respostaAtual || 'Não respondido'
                    };
                    
                    // Próxima pergunta ou finalizar
                    if (this.indiceAtual < this.totalPerguntas - 1) {
                        this.indiceAtual++;
                        this.respostaAtual = this.respostas[this.perguntaAtual.id]?.resposta_usuario || '';
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    } else {
                        this.finalizar();
                    }
                },
                
                voltarPergunta() {
                    if (this.indiceAtual > 0) {
                        this.indiceAtual--;
                        this.respostaAtual = this.respostas[this.perguntaAtual.id]?.resposta_usuario || '';
                    }
                },
                
                // Finalizar
                async finalizar() {
                    this.finalizando = true;
                    clearInterval(this.timerInterval);
                    
                    try {
                        // Preparar dados
                        const respostasArray = Object.values(this.respostas);
                        
                        // Enviar para API
                        const token = localStorage.getItem('token');
                        console.log('Enviando:', JSON.stringify(respostasArray, null, 2));
                        const resposta = await fetch(`${this.apiUrl}/api/avaliar`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                tipo: "completo",
                                respostas: respostasArray
                        })
                        });

                        if (!resposta.ok) throw new Error('Erro ao avaliar respostas');

                        const resultado = await resposta.json();

                        // Salvar no localStorage
                        localStorage.setItem('resultadoVisto', JSON.stringify(resultado));
                        localStorage.setItem('respostasVisto', JSON.stringify(respostasArray));
                        localStorage.setItem('tempoVisto', this.tempoDecorrido);
                        
                        // Redirecionar
                        setTimeout(() => {
                            window.location.href = 'resultado.html';
                        }, 2000);
                        
                    } catch (error) {
                        console.error('Erro ao finalizar:', error);
                        alert('Erro ao processar resultados. Tente novamente.');
                        this.finalizando = false;
                        this.iniciarTimer();
                    }
                }
            }
        }
    </script>

</body>
</html>